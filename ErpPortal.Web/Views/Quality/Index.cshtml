@model IEnumerable<ErpPortal.Domain.Entities.ShopOrderOperation>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Kalite Bekleyen Operasyonlar";
}

<h1 class="text-xl font-bold mb-4">Kalite Bekleyen Operasyonlar</h1>

<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İş Emri</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operasyon</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hurda</th>
            <th class="px-4 py-2"></th>
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
        @foreach (var op in Model)
        {
            <tr>
                <td class="px-4 py-2">@op.OrderNo</td>
                <td class="px-4 py-2">@op.OperationNo</td>
                <td class="px-4 py-2">@op.QuantityScrapped</td>
                <td class="px-4 py-2">
                    <button onclick="showApprove('@op.OrderNo', @op.OperationNo)" class="bg-blue-500 text-white px-3 py-1 rounded">Onayla</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal -->
<div id="approveModal" class="fixed inset-0 hidden items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="bg-white p-6 rounded shadow-lg w-96">
        <h2 class="text-lg font-bold mb-4">Hurda Onayı</h2>
        <form id="approveForm">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Disposition</label>
                <select id="disposition" class="w-full border rounded p-2">
                    <option value="Scrap">Scrap</option>
                    <option value="Rework">Rework</option>
                    <option value="UseAsIs">Use As Is</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Not</label>
                <textarea id="notes" rows="3" class="w-full border rounded p-2"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="submitApprove()" class="bg-green-600 text-white px-4 py-2 rounded">Onayla</button>
                <button type="button" onclick="closeModal()" class="bg-gray-400 text-white px-4 py-2 rounded">İptal</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentOrder = "", currentOp = 0;
    function showApprove(orderNo, opNo) {
        currentOrder = orderNo;
        currentOp = opNo;
        document.getElementById('approveModal').classList.remove('hidden');
    }
    function closeModal() {
        document.getElementById('approveModal').classList.add('hidden');
    }
    async function submitApprove() {
        const disposition = document.getElementById('disposition').value;
        const notes = document.getElementById('notes').value;
        const resp = await fetch(`/api/quality/${currentOrder}/${currentOp}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': '@Antiforgery.GetAndStoreTokens(ViewContext.HttpContext).RequestToken' },
            body: JSON.stringify({ disposition, notes })
        });
        if (resp.ok) {
            window.location.reload();
        } else {
            alert('Onay işlemi başarısız');
        }
    }
</script> 